# MIGRATION_CHAT_FIRST_ADDENDUM

## 0) 本ドキュメントの目的

既存の「チャット主役」仕様に、出面/単価/応援と請求方式（出来高以外も）、Chat-only 移行スイッチを明文化する。Codex が段階的に安全に実装できる自然言語の手順と受け入れ基準を提供する。

---

## 1) ドメインの決定事項（最小）

- 出面（人工）
  - 人工は 1.0 / 0.5 のみ（デフォルト 1.0）
  - 日報の「作業員を選ぶ」→ 丸チップで 1.0/0.5 トグル
  - 12〜14 時台の早上がり推定がある場合のみ、AI が「0.5 にしますか？」と提案（自動変更しない）

- 応援（常用）と単価
  - 人員マスターに従業員/応援を同居
  - 単価は site > client > company > デフォルト の優先順で引当
  - 日報保存時にその日の単価をスナップショット保存（以後の単価変更の影響を受けない）

- 請求方式（サイトごとに初回だけ決める）
  - モード：
    - `progress_monthly`（出来高）
    - `dayrate`（常用：人工×日当）
    - `milestone_plus_progress`（中間金＋出来高）
    - `milestone_only`（節目固定）
    - `delivery_each`（納品都度）
  - 初回請求時はチャットで質問して決定・保存。以後は聞かない（編集は明示操作）
  - 端数処理：1,000 円未満切り捨てを初期値（現場設定で変更可）
  - 残業はデフォルト無効（必要時のみ有効化を質問）

---

## 2) データ（既存を尊重しつつ最小追加）

- `workers`: `id, name, type('employee'|'support'), default_daily_rate, is_active`
- `worker_rates`: `worker_id, scope('company'|'client'|'site'), client_id?, site_id?, daily_rate, effective_from`
- `labor_entries`: `report_id, site_id, date, worker_id, unit(1.0|0.5), daily_rate_at_entry, is_support`
- `site_billing_settings`: `site_id, billing_mode, closing_day('end'|int), rounding('cut'|'round'|'ceil'), overtime_enabled(bool)`
- `milestones`: `site_id, label, type('percent'|'fixed'), value, reached_at?`
- `progress_logs`: `site_id, date, percent, source('ai'|'manual'), note?`

RLS は既存方針（会社スコープ）。代表＝全員、従業員＝自分＋割当現場。

---

## 3) チャットだけモード（移行スイッチ）

- 設定にトグル「チャットだけで操作する」を追加
- ON:
  - FAB 非表示
  - クイックアクションは定型文送信だけに変更
  - 各機能ルートはチャットにリダイレクトして下部シートを開く
- OFF: 現状維持（移行期間の安全弁）

---

## 4) Smart Card 最低仕様（UI は薄いカード＋1px ボーダー）

- ReportCard：現場/日付/作業内容/出面(チップで1.0/0.5)/写真、[確定] [修正]
- ReceiptCard：画像→OCR分類→勘定科目候補、[登録] [修正]
- EstimateCard：行（分類/説明/数量/単位/単価/金額）＋レンジ(low/mid/high)、[作成] [編集]
- InvoiceCard：方式ラベル/期間/明細/合計/根拠リンク、[発行] [プレビュー] [調整]
- WorkSiteCard：現場選択/進捗%/メモ、[切替] [更新]

---

## 5) 自然言語インテント（最小辞書）

- `create_report`：「日報つけて」「今日の分」「作業を記録」「日報」
- `create_invoice`：「請求作って」「請求書」「請求発行」
- `optimize_estimate`：「見積して」「概算見積」「相場」
- `upload_doc`：「レシート」「搬入」「納品書」「資料アップ」「写真送る」
- `update_progress`：「進捗50%」「出来高を60%に」「%更新」
- `open_site_manager`：「現場管理」「現場一覧」「現場切替」

ルータはルール＋軽い正規表現で十分。未知表現は質問で補完。

---

## 6) フェーズ実装（自然言語の指示で進行）

### Phase 0（先行：日報＆レシート）

- 日報をチャット完結
  - 「日報」→ ReportCard を下部シートで開く（遷移なし）
  - 作業員一覧チップで選択、1.0/0.5 トグル、写真添付
  - [確定] で `reports` と `labor_entries` に保存（単価はスナップショット）

- レシート/搬入をチャット完結
  - 画像送信→ ReceiptCard に自動変換（OCR→分類→勘定候補）
  - [登録] で `receipts`/`deliveries` に保存、現場に紐づけ

- 受け入れ基準（Phase 0）
  - 「日報つけて」→ 画面遷移なしで 1.0/0.5 の確定まで到達
  - 「レシート」画像を送信→ チャット内で分類→登録完了
  - 代表アカで当月の総人工/応援人工/人件費概算をカード 1 枚で確認できる

### Phase 1（見積→請求）

- 初回請求方式オンボード（チャットで一度だけ）
  - 未設定サイトで `create_invoice` が来たら、方式/締め/端数/残業を質問→ `site_billing_settings` に保存

- 請求ドラフト API & カード
  - `auto-draft(site, month)` を呼び出し、モード別に自動集計：
    - 出来高＝`contract × (current_progress - prev_billed_progress)`
    - 常用＝`labor_entries` 集計（`1.0/0.5 × daily_rate_at_entry`）
    - 中間金＋出来高／マイルストーン／納品都度＝該当分を計上
  - [根拠を見る] はチャット内モーダルでプレビュー（日報/搬入/レシート/進捗ログ）

- 見積のチャット草案
  - 資料アップ→ EstimateCard に行案＋レンジ（元請け学習は標準係数を適用）
  - [作成] で見積確定、PDF 化＆スレッドへ

- 受け入れ基準（Phase 1）
  - 「請求作って」→ 2 往復以内に現場確定→ドラフト提示→チャット内で発行
  - 「見積にして」→ ファイル添付→ チャット内で草案提示→確定

---

## 7) ルーティングと Chat-only 切替

- 既存ルート（`/reports/create` など）に入ったら必ずチャットに戻し、同じ下部シートを開く
- 設定の「チャットだけで操作する」を ON にすると、FAB 非表示・クイックアクションは定型文送信のみ

---

## 8) デザイン最小ルール

- カード角丸 16、1px ボーダー、影は薄め 1 段
- テキストは見出し/本文/補助の 3 階層のみ
- ダーク：背景 `#0F1115`、カード `#161A22`、境界 `rgba(255,255,255,0.08)`、本文 `#E8EDF7`

---

## 9) テレメトリ（成功指標の計測）

- 記録：`intent_logs (intent, site, 成否, 所要アクション数)`
- ダッシュ：
  - 日報作成の平均所要アクション数
  - レシート登録の完了率
  - 請求作成の“チャット完結”率

---

## 10) 既存仕様との差分（要確認点）

- 出面候補の自動提案はやらない（親方のタップ選択＋AI の 0.5 提案だけ）
- 請求方式は出来高だけに限定しない（初回にモード確定）
- FAB は残すが Chat-only モードで自動非表示
- 画面編集は原則廃止し、閲覧に縮退（段階的に）

---

## 11) 追補（小さな追加仕様）

### 出面の既定・早上がり提案
- 既定は 1.0 人工
- 下部シートの下端に「［全員 0.5 にする］」トグルを常設（個別 1.0/0.5 トグルは従来通り）
- 早上がり提案は「退場時刻が 14:00 以前と推定できたときだけ」提示（手入力・写真 EXIF・位置情報のいずれかで推定／未取得なら提案しない）
- 自動変更はしない（必ず AI が質問→ユーザー確定）

### 応援（常用）ルールの明記
- 応援の月間回数制限なし（現行運用に合わせる）
- 単価は日報ごとに上書き入力を許容し、その値を `daily_rate_at_entry` に確定保存（後日の単価変更の影響を受けない）

### 請求方式オンボードの日本語文面（初回のみ）
- 「この現場の請求は、出来高・常用（日当）・中間金＋出来高・マイルストーン・納品都度のどれで計算しますか？」
- 「締め日は？（月末 / 25 日など）」
- 「端数処理は？（1,000 円未満切り捨て / 四捨五入 / 切り上げ）」
- 「残業代は計算しますか？（建築は通常なし）」

### 端数処理の既定
- 既定は 1,000 円未満切り捨て（現場設定で変更可）

### Chat-only モードの既定
- 初期値は OFF（移行期間の安全弁）
- ON 時：FAB 非表示／クイックは定型文送信のみ／機能ルートはチャットへ自動リダイレクト

### Intent 辞書の表現追加（誤爆防止）
- 請求: 「請求」「請求書」「月次」「締め」「請求出す」
- 見積: 「見積」「見積書」「概算」「金額案」
- 日報: 「日報」「今日の分」「作業記録」「報告」
- 進捗: 「進捗」「出来高」「% 更新」「〇％に」
- 資料: 「レシート」「搬入」「納品書」「写真登録」「書類」
- 現場: 「現場管理」「現場一覧」「現場切替」「現場変えて」

### 根拠モーダルの最小仕様
- チャット内モーダル（遷移なし）
- タブ：日報 / レシート / 搬入 / 写真
- 明細選択時、該当データをハイライト（OCR 抜粋の該当テキストを上部に表示）

### スキーマの補足
- `site_billing_settings.rounding` は `cut|round|ceil` を保存
- `progress_logs` は当月の最新値をドラフト計算で採用
- すべて RLS は会社スコープ（代表 = 全体、従業員 = 自分＋割当現場）

---

## 次アクション（自然言語で指示）

- Phase 0 を実装：「日報とレシートのカード化を、チャット内の下部シートで完結」
- Chat-only トグルを追加して ON 時の挙動を切替
- 既存ルートはチャットにリダイレクトして同じシートを開く

### Done の定義（Phase 0）
- 上記受け入れ基準を満たすこと

---

ご不明点や追加のご要望があればお知らせください。質問はありますか？

---

# 最終確認＆決定

■優先
- Phase 0a → 0b → 1。0a/0b は同ブランチ並行OK（PRは分割）

■下部シート
- Reanimated + Gesture Handler の自前実装（components/chat/BottomSheet 共通）

■OCR
- 0bでは任意：ローカル分類＋金額手入力で成立、後追いで非同期OCR（Edge Functions → Cloud Vision）を反映

■早上がり推定
- ソース優先度＝ 手入力 > EXIF > 位置情報
- 条件＝ 14:00 以前のみ提案（自動変更しない）

■税/単価ルール
- site_billing_settings.tax_rule = "inclusive" | "exclusive"
- 同テーブルに tax_rate(decimal, 既定=10) を保持
- 全体非課税は tax_rate=0 で対応、行単位は invoice_lines.tax_rate_override（任意）で上書き可

■データ
- Supabaseに新規：workers / worker_rates / labor_entries / site_billing_settings / progress_logs / milestones（RLS=会社スコープ）

■Chat-only保存
- Phase 0：AsyncStorage のみ
- Phase 1：profiles.settings.chatOnly:boolean に同期（任意）

■リダイレクト対象
- 作成/編集はチャットへ強制：/reports/create, /reports/edit/*, /invoice/create, /invoice/edit/*, /estimate/new, /estimates/optimize/*, /receipts/capture, /receipts/upload, /progress/update, /work-sites/new, /work-sites/manage
- 閲覧のみ残す：/work-sites/index, /work-sites/detail/*, /invoice/view/*, /estimate/view/*, /reports/detail/*

■テレメトリ
- intent_logs は成功/失敗の両方を記録。failure_reason = NETWORK | PERMISSION | VALIDATION | CANCELLED | OCR_FAIL | UNKNOWN（messageは任意）

■トーン
- 親方口調・短文・敬体・Yes/No確認で統一
- 早上がりの確認文（固定）：
  「今日は14時前に作業終了と推定しました。0.5人工で記入しますか？」

■タイムゾーン取り扱い
- 早上がり判定：EXIF/端末のローカル時刻で判定 → 保存時は Asia/Tokyo に正規化

---

## 追補 v1.1 — Phase 0 実装開始宣言

以下を直ちに実装対象とする（遷移なし・チャット内完結）。

- 「日報」と「レシート/搬入」をチャット内の下部シートで完結
  - 早上がり提案（14:00 以前）を含む（自動変更なし・必ず質問→確定）
  - 当日単価の上書き入力を許容（任意）し、`daily_rate_at_entry` に確定保存
  - 結果カード（ReportCard / ReceiptCard）をスレッドに固定表示

- 設定に「チャットだけで操作する」トグルを追加
  - ON で FAB 非表示＆クイックは定型文送信のみ
  - 既存ルートに入ったら必ずチャットに戻し、同じ下部シートを開く

### DoD（受け入れ基準）
Addendum の Phase 0 に準拠：

- 「日報つけて」→ 2 往復以内で出面（1.0/0.5）確定まで完了（画面遷移なし）
- 「レシート」画像を送信 → チャット内で分類 → 登録まで完了（遷移なし）
- 代表アカウントで当月の総人工・応援人工・概算人件費を 1 枚のカードで確認できる

---

追補 v1.2（表現整理・順序明確化・誤爆防止・DoD精密化）
1) フェーズの粒度を明確化（0 → 1 の間で詰まらないため）

Phase 0a：日報カード

チャット→下部シート（遷移なし）で「作業内容／作業員チップ／人工1.0/0.5／写真」が確定できる。

早上がり提案（14:00以前のみ質問）。当日単価の任意上書き。結果カード固定。

Phase 0b：レシート/搬入カード

1投入口→AI分類→勘定科目候補→登録までチャット内完結。結果カード固定。

Phase 1：請求オンボード＋自動ドラフト

初回のみ方式質問→保存→以降は「請求作って」で即ドラフト→根拠モーダル→発行。

Phase 2：見積草案（元請け学習係数）

資料添付→行案＋金額レンジ→差分指示→PDF。

Phase 3：現場操作のカード化（進捗%・メモ・直近添付）

Phase 4：Chat-only モード既定化（FAB常時OFF、機能ルートはすべてチャットに集約）

以後の議事やPRタイトルにも 「Phase 0a/0b/1…」 を付けて紐付けてください。

2) インテント辞書の誤爆防止（ネガティブルールを追加）

請求（create_invoice）

ポジ：「請求」「請求書」「月次」「締め」「請求出す」

ネガ：**「見積請求」や「請求書っぽい」**等の曖昧表現は確認質問（「請求書を作成しますか？」→はい/いいえ）

見積（optimize_estimate）

ポジ：「見積」「見積書」「概算」「金額案」

ネガ：「請求と見積の比較」→まず目的確認

日報（create_report）

ポジ：「日報」「今日の分」「作業記録」「報告」

ネガ：**「明日の段取り」**はタスク系へ誘導（今は未実装＝質問返し）

資料アップ（upload_doc）

ポジ：「レシート」「搬入」「納品書」「写真登録」「書類」

ネガ：「図面を見て」→見積Intentにバインドする前に確認

ルータ実装メモ：ルール＋正規表現＋否定語/曖昧語で必ず1問確認。2往復超えない。

3) Smart Card の最小UI仕様（文言統一）

カード共通：角丸16／1pxボーダー／影は1段／タイトル左寄せ、右上に軽アクション。

ボタン文言は「名詞→動詞」で統一：

ReportCard：［このまま登録］／［修正する］

ReceiptCard：［登録する］／［修正する］

InvoiceCard：［発行する］／［プレビュー］／［調整する］

EstimateCard：［作成する］／［編集する］

WorkSiteCard：［切り替える］／［更新する］

ダーク：背景 #0F1115／カード #161A22／枠 rgba(255,255,255,0.08)／本文 #E8EDF7（既存トークンにマップ）。

4) Chat-only モードの動作を厳密化

ON時：

FAB 非表示（開いていたら即閉じる・ドラッグ不可）。

クイックアクションは定型文を送るだけ（押下＝チャットにメッセージ投入）。

/reports/create 等の機能ルートに入った瞬間、main-chat へ replace ＋該当Intent開始。

OFF時：現状維持（移行期間の安全弁）。

トグル切替時の即時反映（再起動不要）。

すでに開いている下部シートは維持（中断させない）。

5) 単価と端数のブレ止め（会計ズレを防ぐ）

labor_entries.daily_rate_at_entry は税込／税抜いずれで格納するかをサイト設定に揃える（tax_rule と整合）。

端数処理（既定：1,000円未満切り捨て）は請求書生成の最後に一括適用（行単位切捨ては行わない）。

税率変更に備え、ヘッダに税率を確定保存（実務期ズレの再計算事故を防止）。

6) エッジケースと復旧動線（会話を止めない）

現場未選択：「現在の現場が未選択です。どの現場で進めますか？」→ WorkSiteCard を差し込み。

請求方式未設定：create_invoice 時に自動でオンボード質問開始（1回のみ）。

OCR失敗：ReceiptCardの上部に淡い警告「読み取れませんでした。写真の再撮影か金額の手入力をお願いします。」→ 金額セルを強調。

ネットワーク不調：オフライン表記は出さない（機能停止は**「接続に失敗」簡潔な一行**に統一）。

ロール制限：従業員が他者の出面を触った場合は上部バナーで理由表示＋自分の行だけ編集可。

7) テレメトリ（成功指標の計測粒度を合わせる）

intent_logs: intent, site_id, success(bool), steps(int), duration_ms

主要イベント：

report_committed（人工合計・応援人工・当日上書き件数）

receipt_registered（分類結果・修正有無）

invoice_issued（mode, lines, evidence_count, rounding）

ダッシュ指標：

日報の平均アクション数、レシート登録完了率、請求“チャット完結”率。

8) DoD（受け入れ基準）を精密化（Phase 0）

「日報つけて」→ 遷移なしで 1.0/0.5 確定・保存・結果カード固定まで 2往復以内。

「レシート（画像投下）」→ チャット内で分類→登録→結果カード固定。

代表アカウントで当月：総人工／応援人工／概算人件費がカード1枚で確認できる。

Chat-only ON：FAB非表示、クイックは定型文送信のみ、機能ルートはチャットへ強制集約。

すべての警告文は1行・簡潔・敬体（例：「接続に失敗しました。しばらくしてからお試しください。」）。

9) 文面トーン（親方口調を尊重）

質問は短く要点だけ：「0.5人工で記入しますか？」／「どの現場ですか？」

提案は断定しない：「この金額案で作成します。よろしいですか？」

技術語は避ける：「端数処理 → 端数の丸め」「ドラフト → 下書き」

10) 実装順メモ（Codex向け）

Phase 0a/0b を同ブランチで進行（チャット下部シート共通化・カードUI・結果固定）。

Chat-only トグルの実装（ON/OFFで即反映）。

既存ルートの自動リダイレクトと Intent 開始。

テレメトリ投入（イベント3種＋intent_logs）。

DoDチェック表でQA。

---

## 追補 v1.3（税・TZ・確認文の確定）

■ 税ルールの確定
- site_billing_settings.tax_rule は "inclusive" | "exclusive" の2値
- 同テーブルに tax_rate (既定=10) を追加
- 全体非課税は tax_rate=0 で表現、行単位の例外は invoice_lines.tax_rate_override で上書き

■ タイムゾーンの取り扱い
- 早上がり判定は端末/EXIFのローカル時刻で行い、保存時は Asia/Tokyo に正規化して比較・集計
- 集計境界は 00:00（Asia/Tokyo）固定

■ 早上がりの確認文（固定）
- 「今日は14時前に作業終了と推定しました。0.5人工で記入しますか？」（Yes/No）
